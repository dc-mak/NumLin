\section{Proofs}

\subsection{Lemmas}

\subsubsection{$
    \forall \sigma_s, \sigma_r, e.\ \varsigma_s \star \varsigma_r \textrm{ defined }
    \Rightarrow \forall n.\ \langle \sigma_s, e \rangle \rightarrow^n =
    \langle \sigma_f \cup \sigma_r , e \rangle \rightarrow^n
$}\label{frame}

\begin{proof}

    \pfsketch{~By induction on $n$, consider only the cases
        $\langle \sigma_s, e \rangle \rightarrow \langle \sigma_f, e_f \rangle$
        where $\sigma_s \neq \sigma_f$.\\
        Only \textsc{Op\_\{Free,Matrix,Share,Unshare\_Eq,Gemm\_Match\}} change
        the heap.\\
        The rest are either parametric in the heap or step to an $\ottkw{err}$.\\}

    \prove{$\langle \sigma_s \cup \sigma_r, e \rangle \rightarrow
        \langle \sigma_f \cup \sigma_r, e_f \rangle$.\\}

    \step{}{\case{\textsc{Op\_Free}, $\sigma_s \equiv \sigma' \cup \{ l
        \mapsto_1 m \}$, $\sigma_f = \sigma'$.}{\pf~Instantiate
        \textsc{Op\_Free} with $(\sigma' \cup \sigma_r) \cup \{ l \mapsto_1 m
        \}$,\\valid because $l \notin \dom(\varsigma_r)$ by $\varsigma' \star
        [l \mapsto_1 m] \star \varsigma_r$ defined (assumption).}}

    \step{}{\case{\textsc{Op\_Matrix}}{
        \pf~Rule has no requirements on $\sigma_s$ so will also work with
        $\sigma_s \cup \sigma_r$.
    }}

    \step{}{\case{\textsc{Op\_Share}}{
        \pf~Union-ing $\sigma_r$ does not remove elements, so we can still
        split up $ \sigma_s \cup \sigma_r$ as originally.
    }}

    \step{}{\case{\textsc{Op\_Unshare\_Eq}}{
        \pf~By assumption of $\varsigma_s \star \varsigma_r$ defined, we know
        any splitting of $\sigma_s \cup \sigma_r$ will satisfy $f \leq 1$.
    }}

    \step{}{\case{\textsc{Op\_Gemm\_Match}}{
        \pf~None of the permissions are changed, only the pointed to matrix
        value at $l_3$. By assumption of $\varsigma_s \star \varsigma_r$
        defined, $l_3 \notin \dom(\varsigma_r)$ so not in $\sigma_r$ (cannot be
        affected by its union to $\sigma_s$). As for $l_1$ and $l_2$, their
        permissions are universally quantified over, and so will not be
        affected by union-ing $\sigma_r$ to $\sigma_s$.
    }}

\end{proof}

\subsubsection{$\forall k, t.\ \V{k}{t} \subseteq \C{k}{t}$}\label{subsetVC}
Follows from definition of $\C{k}{t}$, $\rightarrow^j$ for arbitrary $j \leq k$
and \ref{frame}.

\subsubsection{$\forall \delta, \gamma, v.\ \delta(\gamma(v))\textrm{ is a value.}$}\label{valueSub}

By construction, $\delta$ and $\gamma$ only map variables to values, and values
are closed under substitution.

\subsubsection{$
    \forall k, \sigma, \sigma', e, e', t.  \ (\varsigma', e') \in \C{k}{t} \wedge
    \langle \sigma, e \rangle \rightarrow \langle \sigma', e' \rangle
    \Rightarrow (\varsigma, e) \in \C{k+1}{t}
$}\label{stepInC}

Assume arbitrary $j \leq k + 1$. If $j=0$, then in trivally. If $j \geq 1$,
then take a step and appeal to assumption, with $j-1 \leq k$.

\subsubsection{$j \leq k \Rightarrow \den{\_\ }{k}{\cdot} \subseteq \den{\_\ }{j}{\cdot}$}\label{subsetKJ}

\subsection{Soundness}
\[
    \forall \Theta, \Delta, \Gamma, e, t.\ \Theta; \Delta ; \Gamma \vdash e : t \Rightarrow
    \forall k.\ \den{}{k}{ \Theta; \Delta ; \Gamma \vdash e : t }
\]

\begin{proof}

    \pfsketch{ Induction over the typing judgements.\\ }

    \assume{%
        \begin{pfenum}
            \item Arbitrary $\Theta, \Delta, \Gamma, e, t$ such that $\Theta; \Delta ; \Gamma \vdash e : t$.
            \item Arbitrary $\theta, k, \delta, \gamma, \sigma$ such that:
                \begin{pfenum}
                    \item $\textrm{dom}(\Theta) = \textrm{dom}(\theta)$
                    \item $(\sigma, \gamma) \in \den{L}{k}{\Gamma}\theta$\label{inL}
                    \item $\delta \in \den{I}{k}{\Delta}\theta$.\label{inI}
                \end{pfenum}
            \item W.l.o.g., all variables are distinct/$\dom(\Delta)$ and
                $\dom(\Gamma)$ are disjoint.\label{disjoint}
            \item And so that over expressions $\gamma \circ \delta = \delta \circ \gamma$.
            \item By construction, $\dom(\Delta) = \dom(\delta)$ and $\dom(\Gamma) = \dom(\gamma)$.\label{samedom}
        \end{pfenum}
    }

    \prove{$(\sigma, \gamma(\delta(e))) \in \C{k}{\theta(t')}$.}
    \assume{Arbitrary $j \leq k$ and $\sigma_{r}$.}
    \suffices{Show whole expression either reduces to $\ottkw{err}$ or takes $j$ steps.\\}

    \step{}{%
        \case{%
            \textsc{Ty\_Let}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, x\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$.}

            \suffices{$(\sigma, \ottkw{let}\, x\, =\, \gamma(\delta(e))\,
                \ottkw{in}\, \gamma(\delta(e'))) \in \C{k}{\theta(t')}$.}

        }
    }

    \begin{proof}
        \step{}{By induction,
            \begin{pfenum}
                \item $\den{}{}{\Theta; \Delta; \Gamma \vdash e : t}$\label{IH1}
                \item $\den{}{}{\Theta; \Delta; \Gamma', x : t \vdash e' : t'}$\label{IH2}.
            \end{pfenum}}\pflabel{IH}

        \step{}{By \ref{inL} and induction on $\Gamma'$, we know there exist
                $\sigma_{e'},\; (\sigma_e, \gamma_e) \in \den{L}{k}{\Gamma}$, \\
                such that $\sigma = \sigma_e \star \sigma_{e'}$.}\pflabel{split}

        \step{}{So, using them, $\theta, k, \delta$, and \ref{disjoint} we have
            $(\sigma_e, \gamma_e(\delta(e))) \in \C{k}{\theta(t)}$.}

        \step{}{By \ref{disjoint}, $(\sigma_e, \gamma(\delta(e))) \in \C{k}{\theta(t)}$.}

        \step{}{By definition of $\C{k}{\cdot}$ and \pfref{split}, we
            instantiate with $j$ and $\sigma_r = \sigma_{e'}$ to
            conclude that $\langle \sigma , \gamma(\delta(e)) \rangle$
            either reduces to $\ottkw{err}$ or another heap and expression.}

        \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err} and \ref{disjoint},
            the whole expression reduces to $\ottkw{err}$ in $j \leq k$ steps. Since $j \leq k$ and
            $\sigma_{r}$ (for \ref{frame}) are arbitrary, $(\sigma, \gamma(\delta(\ottkw{let}\,
            x\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$.}}

        \step{}{\case{$j$ steps to another heap and expression.}By \textsc{Op\_Context} and
            \ref{disjoint}, the whole expression does the same.}

        \step{}{If it is not a value, we are done. ??? If it is $({\sigma_e}_f, v)
            \in \V{k-j}{\theta(t)}$ by \ref{valueSub}. \suffices{$({\sigma_e}_f \star
            \sigma_{e'}, \ottkw{let}\, x\, =\, v\, \ottkw{in}\, \gamma(\delta(e'))) \in
            \C{k-j}{\theta(t')}$.} \suffices{??? $({\sigma_e}_f \star \sigma_{e'},
            \gamma(\delta(e')) [x/v]) \in \C{k-j-1}{\theta(t')}$ by \ref{stepInC}.}}

        \step{}{\define{$\gamma_{e'} (y) = v$ if $ y=x $ and $\gamma(y)$ if $y \in \dom(\Gamma')$.}
            ??? Thus, by \ref{subsetKJ}, $(\sigma_{e'}, \gamma_{e'}) \in \den{L}{k}{\Gamma',
            x : t}\theta \subseteq \den{L}{k-j-1}{\Gamma', x : t}\theta$.}

        \step{}{Instantiate \ref{IH2} of step \pfref{IH} with $\theta, k-j-1, \delta,
            \gamma_{e'}, \sigma_{e'}$ to conclude \\ $(\sigma_{e'}, \gamma_{e'}(\delta(e')))
            \in \C{k-j-1}{\theta(t')}$.}

        \step{}{By \ref{disjoint}, we have $\gamma(\delta(e')) [x/v] =
            \gamma_{e'}(\delta(e'))$ and by \ref{frame} we conclude \\ $({\sigma_e}_f \star
            \sigma_{e'}, \gamma(\delta(e')) [x/v]) \in \C{k-j-1}{\theta(t')}$}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Pair\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, (a, b)\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$.}
            {\pf\ Similar to \textsc{Ty\_Let} but with \textsc{Op\_Let\_Pair}}
        }
    }

    \begin{proof}

        \step{}{When $({\sigma_e}_f, v) \in \V{k-j}{\theta(t_1) \otimes \theta(t_2)}$, we have
            $v = (v_1, v_2)$.}

        \step{}{\suffices{??? $(\sigma_{e'}, \gamma(\delta(e'))) \in
            \C{k-j-1}{\theta(t')}$ by \ref{stepInC}.}}

        \step{}{\define{$\gamma_{e'}$ to be the restriction of $\gamma$ to $\dom(\Gamma')$.}
            ??? Thus, by \ref{subsetKJ}, $(\sigma_{e'}, \gamma_{e'}[a \mapsto v_1, b \mapsto v_2 ])
            \in \den{L}{k}{\Gamma', a : t_1, b : t_2 }\theta \\ \subseteq \den{L}{k-j-1}{\Gamma',
            a : t_1, b : t_2}\theta$.}

        \step{}{Instantiate $\den{}{}{\Theta; \Delta; \Gamma', a : t_1, b : t_2 \vdash e' : t'}$
            with $\theta, k-j-1, \delta, \gamma_{e'} [a \mapsto v_1, b \mapsto v_2 ] , \sigma_{e'}$.}

        \step{}{??? By \ref{disjoint} $(\sigma_{e'}, \gamma(\delta(e'))) \in
            \C{k-j-1}{\theta(t')}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Bang\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, \ottkw{Many}\, x\, =\, e\, \ottkw{in}\, e')))
                \in \C{k}{\theta(t)}$.}
            {\pfsketch\ Similar to \textsc{Ty\_Let}, but with the following key differences.}
        }
    }

    \begin{proof}

        \step{}{When $({\sigma_e}_f, v) \in \V{k-j}{\theta(!t)}$, since $\V{k-j}{\theta(!t)}
            = \V{k-j}{!\theta(t)}$,\\ we have ${\sigma_e}_f = \empH$ and $v = \ottkw{Many}\, v'$
            for some $(\empH, v') \in \V{k-j}{\theta(t)}$.}

        \step{}{\suffices{$(\sigma_{e'}, \ottkw{let}\, \ottkw{Many}\, x\, =\, \ottkw{Many}\,
            v'\, \ottkw{in}\, \gamma(\delta(e'))) \in \C{k-j}{\theta(t)}$.}}

        \step{}{\suffices{$(\sigma_{e'}, \gamma(\delta(e')) [ x / v ]) \in \C{k-j-1}{\theta(t)}$.}}

        \step{}{\define{$\gamma_{e'}$ as the restriction of $\gamma$ to $\dom(\Gamma')$.}}

        \step{}{Instantiate $\den{}{}{\Theta; \Delta, x : t, \Gamma' \vdash e' : t'}$ with
            $\theta, k-j-1, \delta_{e'} = \delta[x \mapsto v'], \gamma_{e'}, \sigma_{e'}$ to
            conclude \\ $(\sigma_{e'}, \gamma_{e'}(\delta_{e'}(e'))) \in \C{k-j-1}{\theta(t)}$.}

        \step{}{??? By \ref{disjoint}, $(\sigma_{e'}, \gamma(\delta(e')) [ x / v ]) \in
            \C{k-j-1}{\theta(t)}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Unit\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, ()\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t)}$.}
            {\pf\ Similar to \textsc{Ty\_Let} but with \textsc{Op\_Let\_Unit}.}

        }
    }

    \begin{proof}

        \step{}{When $({\sigma_e}_f, v) \in \V{k-j}{\ottkw{unit}}$, we have ${\sigma_e}_f =
            \empH$ and $v = ()$.}

        \step{}{\suffices{??? $(\sigma_{e'}, \gamma(\delta(e'))) \in
            \C{k-j-1}{\theta(t')}$ by \ref{stepInC}.}}

        \step{}{\define{$\gamma_{e'}$ to be the restriction of $\gamma$ to $\dom(\Gamma')$.}
            ??? Thus, by \ref{subsetKJ}, $(\sigma_{e'}, \gamma_{e'}) \in \den{L}{k}{\Gamma'}\theta
            \subseteq \den{L}{k-j-1}{\Gamma'}\theta$.}

        \step{}{Instantiate $\den{}{}{\Theta; \Delta; \Gamma' \vdash e' : t'}$ with $\theta,
            k-j-1, \delta, \gamma_{e'}, \sigma_{e'}$.}

        \step{}{??? By \ref{disjoint} $(\sigma_{e'}, \gamma(\delta(e'))) \in
            \C{k-j-1}{\theta(t')}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Bool\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{if}\, e\, \ottkw{then}\,
                e_1\, \ottkw{else}\, e_2))) \in \C{k}{\theta(t)}$.}
                {\pf\ Similar to \textsc{Ty\_Unit\_Elim} but with \textsc{Op\_If\_\{True,False\}}\\
                and ${\sigma_e}_f = \empH$ and $v = \ottkw{Many}\, \ottkw{true}$ or
                $v = \ottkw{Many}\, \ottkw{false}$.}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bang\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{Many}\, e))) \in \C{k}{\theta(!t)}$.}
            \suffices{$(\sigma, \ottkw{Many}\, \gamma(\delta(e))) \in \C{k}{!\theta(t)}$.}
        }

    }

    \begin{proof}

        \step{}{By assumption of \textsc{Ty\_Bang\_Intro}, $e = v$ for some
            value $v \neq l$, $\Gamma = \empH$ and so \\ $\den{}{}{\Theta;
            \Delta; \cdot \vdash v : t}$ by induction.}

        \step{}{\suffices{$(\empH, \ottkw{Many}\, \delta(v)) \in
            \C{k}{!\theta(t)}$ by \ref{disjoint} and \ref{inL}.}}

        \step{}{Instantiate $\den{}{}{\Theta; \Delta; \cdot \vdash v : t}$
            with $\theta, k, \delta, \gamma = [], \sigma = \empH$ to obtain
            $(\empH, \delta(v)) \in \C{k}{\theta(t)}$.}

        \step{}{Instantiate $(\empH, \delta(v)) \in \C{k}{\theta(t)}$ with $j=0$, and
            $\sigma_r = \empH$, to conclude $(\empH, v) \in \V{k}{\theta(t)}$.}

        \step{}{??? By definition of $\V{k}{!\theta(t)}$, \ref{valueSub} and \ref{subsetVC} we
            have $(\empH, \ottkw{Many}\, \delta(v)) \in \C{k}{!\theta(t)}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Pair\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\, ( e, e')\, ))) \in \C{k}{\theta(t \otimes t')}$.}
            \assume{Arbitrary $j \leq k$ and $\sigma_{r}$.}
            \suffices{Show whole expression either reduces to $\ottkw{err}$ or a heap and
                expression in $j$ steps.}
        }
    }

    % Intro dual of Unit_Elim
    \begin{proof}

        \step{}{\define{$(\sigma_1, \gamma_1) \in \den{L}{j}{\Gamma}$ similar to
            $(\sigma_e, \gamma_e)$ in \textsc{Ty\_Let}.}}

        \step{}{By induction,
            \begin{pfenum}
                \item $\den{}{}{\Theta; \Delta; \Gamma_1 \vdash e_1 : t_1 }$
                \item $\den{}{}{\Theta; \Delta; \Gamma_2 \vdash e_2 : t_2 }$.
            \end{pfenum}}

        \step{}{Instantiate the first with $\theta, k, \delta, \gamma_1, \sigma_1$.}

        \step{}{Therefore, $(\sigma_1, \gamma_1(\delta(e_1))) \in \den{C}{k}{\theta(t)}$.}

        \step{}{So, $(\sigma_1 \star \sigma_2, \gamma_1(\delta(e_1)))$ either reduces to
            $\ottkw{err}$ or a heap and expression in $j$ steps.}

        \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err} and \ref{disjoint},
            so too does the whole expression. Since $j \leq k$ and $\sigma_{r}$ (for \ref{frame})
            are arbitrary, $(\sigma, \gamma(\delta(\, (e, e')\, ))) \in
            \C{k}{\theta(t \otimes t')}$.}}

        \step{}{\case{$j$ steps to another heap and expression.}By \textsc{Op\_Context} and
            \ref{disjoint}, the whole expression does the same.}

        \step{}{If it is not a value, we are done. ??? If it is $({\sigma_1}_f, v_1)
            \in \V{k-j}{\theta(t_1)}$ by \ref{valueSub}. \suffices{??? By \ref{stepInC},
            $({\sigma_1}_f \star \sigma_{e_2}, \, (v_1, e_2)\, ) \in \C{k-j}{\theta(t_1 \otimes
            t_2)}$.}}

        \step{}{Instantiate the second IH with $\theta, j, \delta, \gamma_2, \sigma_2$ defined as
            per usual.}

        \step{}{So, $({\sigma_1}_f \star \sigma_2, \gamma_2(\delta(e_2)))$ either reduces to
            $\ottkw{err}$ or a heap and expression in $j$ steps.}

        \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err}, \ref{disjoint}, so too
            does the whole expression. Since $j \leq k$ and $\sigma_r$ (for \ref{frame}) are
            arbitrary, $(\sigma_{e_2}, \, (v_1, e_2)\, ) \in \C{k-j}{\theta(t_1
            \otimes t_2)}$.}}

        \step{}{\case{$j$ steps to another heap and expression.}By \textsc{Op\_Context} and
            \ref{disjoint}, the whole expression does the same.}

        \step{}{If it is not a value, we are done. ??? If it is $({\sigma_2}_f, v_2)
            \in \V{k-j}{\theta(t_2)}$ by \ref{valueSub}. \suffices{??? By \ref{stepInC},
            $({\sigma_1}_f \star {\sigma_2}_f, \, (v_1, v_2)\, ) \in \C{k-2j}{\theta(t_1
            \otimes t_2)}$.}}

        \step{}{??? By \ref{subsetKJ} and \ref{subsetVC}, $({\sigma_1}_f \star {\sigma_2}_f, \,
            (v_1, v_2)\, ) \in \V{k-j}{\cdot} \subseteq \V{k-2j}{\cdot} \subseteq \C{k-2j}{\cdot}$
            as needed.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Lambda}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{fun}\, x : t \rightarrow e))) \in
                \C{k}{\theta(t \multimap t')}$.}

            \suffices{??? By 6, to show $\ldots \in \V{k}{\theta(t \multimap t')}$.}

            \assume{Arbitrary $j<k$, $(\sigma_v, v) \in \V{j}{\theta(t)}$ such that $\sigma \star
                \sigma_v$ is defined.}

            \suffices{$(\sigma \star \sigma_v, \gamma(\delta(\ottkw{fun}\, x : t \rightarrow
                e))\, v) \in \C{j}{\theta(t')}$.}

            \suffices{$(\sigma \star \sigma_v, \gamma(\delta(e)) [ x / v]) \in \C{j}{\theta(t')}$.}

        }
    }

    \begin{proof}

        \step{}{By induction, $\den{}{}{\Theta; \Delta; \Gamma, x : t \vdash e}$.}

        \step{}{Instantiate it $\theta, j-1, \gamma[x \mapsto v], \sigma_v \star \sigma$.}

        \step{}{Hence, $(\sigma_v \star \sigma, \gamma[x \mapsto v](\delta(e))) \in \C{j-1}{\theta(t)}$.}

        \step{}{??? By \ref{disjoint}, we are done.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_App}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\,e \,e'\,))) \in \C{k}{\theta(t)}$.}
            \assume{Arbitrary $j$ and $\sigma_r$ such that $\sigma \star \sigma_r$ defined.}
            \suffices{Show whole expression either reduces to $\ottkw{err}$ or a heap and
            expression in $j$ steps.}
        }
    }

    % Intro dual of Let
    \begin{proof}

        \step{}{By induction,
            \begin{pfenum}
                \item $\den{}{}{\Theta; \Delta; \Gamma \vdash e : t' \multimap t }$
                \item $\den{}{}{\Theta; \Delta; \Gamma' \vdash e' : t' }$.
            \end{pfenum}}

        \step{}{Instantiate the first with $\theta, k, \delta, \gamma_e, \sigma_e$ as per usual
            definitions, \\ to conclude $(\sigma_e, \gamma_e(\delta(e))) \in
            \C{k}{\theta(t' \multimap t)}$.}

        \step{}{Instantiate \emph{this} with $j$ and $\sigma_{e'}$ to conclude
            $(\sigma = \sigma_e \star \sigma_{e'}, \gamma(\delta(\, e \, e'\,)))$ reduces to
            $\ottkw{err}$ or another heap and expression in $j$ steps (using \ref{disjoint}).}

        \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err}, so too does the whole
            expression.\\ Since $j \leq k$ and $\sigma_{r}$ (for \ref{frame}) are arbitrary,
            $(\sigma, \gamma(\delta(\, e\, e'\, ))) \in \C{k}{\theta(t' \multimap t)}$.}}

        \step{}{\case{$j$ steps to another heap and expression.}By \textsc{Op\_Context},
            the whole expression does the same. \\ If it is not a value, we are done. \\
            ??? If it is $({\sigma_e}_f, \ottkw{fun}\, x : t \rightarrow e_b) \in
            \V{k-j}{\theta(t' \multimap t)}$ by \ref{valueSub}.}

        \step{}{\suffices{??? By \ref{stepInC}, to show $({\sigma_e}_f \star \sigma_{e'},
            \gamma(\delta(\, (\ottkw{fun}\, x : t \rightarrow e_b)\, e'))) \in \C{k-j}{\theta(t)}$.}}

        \step{}{Instantiate the second IH with $\theta, j, \delta, \gamma_{e'}, \sigma_{e'}$
            defined as per usual.}

        \step{}{So, $({\sigma_e}_f \star \sigma_{e'}, \gamma_{e'}(\delta(e')))$
            either reduces to $\ottkw{err}$ or a heap and expression in $j$ steps.}

        \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err} and \ref{disjoint}, so too
            does the whole expression. Since $j \leq k$ and $\sigma_r$ (for \ref{frame}) are
            arbitrary, $({\sigma_e}_f \star \sigma_{e'}, \gamma(\delta(\,
            (\ottkw{fun}\, x : t \rightarrow e_b)\, e') )) \in \C{k-j}{\theta(t)}$.}}

        \step{}{\case{$j$ steps to another heap and expression.} By \textsc{Op\_Context} and
            \ref{disjoint}, the whole expression does the same.}

        \step{}{If it is not a value, we are done. ??? If it is, by definition of $({\sigma_e}_f,
            \ottkw{fun}\, x : t \rightarrow e_b) \in \V{k-j}{\theta(t' \multimap t)}$, we have
            $({\sigma_e}_f \star {\sigma_{e'}}_f, \gamma(\delta(\, (\ottkw{fun}\, x : t \rightarrow
            e_b)\, v'))) \in \C{k-2j}{\theta(t)}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Gen}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{fun}\, fc \rightarrow e))) \in \C{k}{\theta(\forall \, fc.\, t)}$.}
        }
    }

    \begin{proof}
    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Spc}.
        }{%
            \prove{$(\sigma, \gamma(\delta(e\, [f]))) \in \C{k}{\theta(t\, [fc/f])}$.}
        }
    }

    \begin{proof}
    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Fix}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{fix} (g, x : t, e : t')))) \in
                \C{k}{\theta(!(t \multimap t'))}$.}

            \suffices{??? to show $ \ldots \in \V{k}{!(\theta(t) \multimap
                \theta(t'))}$, by \ref{subsetVC}.}
        }
    }

    \begin{proof}

        \step{}{\assume{Arbitrary $j < k$ and $(\sigma, v) \in \V{j}{\theta(t)}$.}}

        \step{}{\suffices{$(\sigma, \emph{letManyG } g\, v) \in \C{j}{\theta(t')}$.}}

        \step{}{\pflet{$e_1 = e [ g / \ottkw{fun}\, x : t \rightarrow \emph{letManyG } g\, x ]$.}}

        \step{}{\suffices{??? by \ref{stepInC}, $(\sigma, (\ottkw{fun}\, x : t \rightarrow e_1)\, v)
            \in \C{j-1}{\theta(t')}$.}}

        \step{}{\suffices{??? by \ref{stepInC}, $(\sigma, e_1 [ x / v ]) \in \C{j-2}{\theta(t')}$.}}

        \step{}{By induction, we have $\den{}{}{\Theta; \Delta, g : t \multimap t';
            x : t \vdash e : t'}$.}

        \step{}{Instantiate this with $\theta, j-2, \delta[g \mapsto \ottkw{fun}\, x : t
            \rightarrow e_1 ], \gamma = [ x \mapsto v ], \sigma$ (???).
            \prove{$(\sigma, \ottkw{fun}\, x : t \rightarrow e_1) \in \V{j-2}{\theta(t)
            \multimap \theta(t')}$.}}

            \begin{proof}

                \step{}{\suffices{??? by \ref{stepInC}, $(\sigma', e_1 [ x / v']) \in
                    \C{j-2}{\theta(t')}$ for arbitrary $(\sigma', v') \in \V{j-2}{\theta(t)}$.}}

                \step{}{We can again use the induction hypothesis $\den{}{}{\Theta;
                        \Delta, g : t \multimap t'; x : t \vdash e : t'}$.}

                \step{}{But since it's true for $\C{0}{\cdot}$ (base case), it's true
                    by induction ???}

            \end{proof}

            \step{}{Lastly, we show $\delta(\gamma(e)) = e_1 [ x / v ]$, which follows
                by their definitions, \\ to conclude $(\sigma, e_1 [ x / v ]) \in
                \C{j-2}{\theta(t')}$.}

    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Var\_Lin}.
        }{%
            \prove{$(\sigma, \gamma(\delta(x))) \in \C{k}{\theta(t)}$.}
        }
    }

    \begin{proof}
        \step{}{$\Gamma = \{ x : t\}$ by assumption of \textsc{Ty\_Var\_Lin}.}
        \step{}{\suffices{$(\sigma, \gamma(x)) \in \C{k}{\theta(t)}$ by \ref{disjoint}.}}
        \step{}{By \ref{inL}, there exist $(\sigma_x, v_x) \in \V{k}{\theta(t)}$, such
            that $\sigma=\sigma_x$ and $\gamma = [x \mapsto v_x]$.}
        \step{}{??? Hence, $(\sigma_x, v_x) \in \C{k}{\theta(t)}$, by \ref{subsetVC}.}
    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Var}.
        }{%
            \prove{$(\sigma, \gamma(\delta(x))) \in \C{k}{\theta(t)}$.}
        }
    }

    \begin{proof}
        \step{}{$x : t \in \Delta$ and $\Gamma = \empH$ by assumption of \textsc{Ty\_Var}.}
        \step{}{\suffices{$(\empH, \delta(x)) \in \C{k}{\theta(t)}$ by \ref{disjoint} and \ref{inL}.}}
        \step{}{By \ref{inI}, there exists $v_x$ such that $(\empH, v_x) \in \V{k}{\theta(t)}$.}
        \step{}{??? Hence, $(\empH, v_x) \in \C{k}{\theta(t)}$, by \ref{subsetVC}.}
    \end{proof}

    \step{}{%
        \case{%
            \textsc{Ty\_Unit\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\, ()\,))) \in \C{k}{\theta(\Unit)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bool\_True}, \textsc{Ty\_Bool\_False}, \textsc{Ty\_Int\_Intro}, \textsc{Ty\_Elt\_Intro}.
        }{%
            Similar to \textsc{Ty\_Unit\_Intro}.
        }
    }

\end{proof}
