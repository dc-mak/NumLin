\section{Soundness Proof}

\[
    \forall \Theta, \Delta, \Gamma, e, t.\ \Theta; \Delta ; \Gamma \vdash e : t \Rightarrow
    \den{}{}{ \Theta; \Delta ; \Gamma \vdash e : t }
\]

\begin{proof}

    \pfsketch{ Induction over the typing judgements.\\ }

    \assume{%
        \begin{pfenum}
            \item Arbitrary $\Theta, \Delta, \Gamma, e, t$ such that $\Theta; \Delta ; \Gamma \vdash e : t$.
            \item Arbitrary $\theta, k, \delta, \gamma, \sigma$ such that:
                \begin{pfenum}
                    \item $\textrm{dom}(\Theta) = \textrm{dom}(\theta)$
                    \item $(\sigma, \gamma) \in \den{L}{k}{\Gamma}\theta$\label{inL}
                    \item $\delta \in \den{I}{k}{\Delta}\theta$.\label{inI}
                \end{pfenum}
            \item W.l.o.g., all variables are distinct/$\dom(\Delta)$ and
                $\dom(\Gamma)$ are disjoint.\label{disjoint}
            \item And so that over expressions $\gamma \circ \delta = \delta \circ \gamma$.
            \item By construction, $\dom(\Delta) = \dom(\delta)$ and $\dom(\Gamma) = \dom(\gamma)$.\label{samedom}
            \item ??? $\V{k}{\theta(t)} \subseteq \C{k}{\theta(t)}$.\label{subsetVC}
            \item ??? ``Stronger heap''/frame rule: $\langle \sigma, e \rangle
                \rightarrow^* = \langle \sigma \star \sigma_r , e \rangle \rightarrow^*$.\label{frame}
            \item ??? $\forall \delta, \gamma, v.\: \delta(\gamma(v))$ is a value.\label{valueSub}\\
        \end{pfenum}
    }

    \prove{$(\sigma, \gamma(\delta(e))) \in \C{k}{\theta(t')}$.}
    \assume{Arbitrary $j < k$ ($k=0$ ???) and $\sigma_{r'}$.}
    \suffices{Show whole expression either reduces to $\ottkw{err}$ or takes $j$ steps.\\}

    \step{}{%
        \case{%
            \textsc{Ty\_Let}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, x\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$.}

            \suffices{$(\sigma, \ottkw{let}\, x\, =\, \gamma(\delta(e))\,
                \ottkw{in}\, \gamma(\delta(e'))) \in \C{k}{\theta(t')}$.}

            \begin{proof}
                \step{}{By induction, $\den{}{}{\Theta; \Delta; \Gamma \vdash e : t}$ and
                    $\den{}{}{\Theta; \Delta; \Gamma', x : t \vdash e' : t'}$.}

                \step{}{By \ref{inL} and induction on $\Gamma'$, we know there exist
                        $\sigma_{e'},\; (\sigma_e, \gamma_e) \in \den{L}{k}{\Gamma}$, \\
                        such that $\sigma = \sigma_e \star \sigma_{e'}$.}\pflabel{split}

                \step{}{So, using them, $\theta, k, \delta$, and \ref{disjoint} we have
                    $(\sigma_e, \gamma_e(e)) \in \C{k}{\theta(t')}$.}

                \step{}{By \ref{disjoint}, $(\sigma_e, \gamma(\delta(e))) \in \C{k}{\theta(t')}$.}

                \step{}{By definition of $\C{k}{\cdot}$ and \pfref{split}, we
                    instantiate with $j$ and $\sigma_r = \sigma_{e'}$ to
                    conclude that $\langle \sigma , \gamma(\delta(e)) \rangle$
                    either reduces to $\ottkw{err}$ or another heap and expression.}

                \step{}{\case{$\ottkw{err}$}{??? By \textsc{Op\_Context\_Err}
                    and \ref{frame} with $\sigma_{r'}$, the whole expression
                    reduces to $\ottkw{err}$ in $j<k$ steps. Since $j<k$ and
                    $\sigma_{r'}$ are arbitrary, $(\sigma, \gamma(\delta(\ottkw{let}\,
                    x\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$.}}

                \step{}{\case{$j$ steps to another heap and expression.}By
                    \textsc{Op\_Context}, the whole expression does the same.}

                \step{}{Regardless of whether $\gamma(\delta(e))$ is a
                    syntactic value in $j<k$ steps, it will take at least $j+1 \leq k$ steps
                    to trigger \textsc{Op\_Let\_Var} and so the whole
                    expression cannot be a syntactic value after $j<k$ steps.}

                \step{}{Therefore, $(\sigma, \gamma(\delta(\ottkw{let}\,
                    x\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t')}$}

            \end{proof}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Unit\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, ()\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t)}$.}
            {\pf\ Similar to \textsc{Ty\_Let} but with \textsc{Op\_Let\_Unit}.}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bool\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{if}\, e\, \ottkw{then}\,
                e_1\, \ottkw{else}\, e_2))) \in \C{k}{\theta(t)}$.}
                {\pf\ Similar to \textsc{Ty\_Let} but with \textsc{Op\_If\_\{True,False\}}.}

            % \suffices{$(\sigma, \ottkw{if}\, \gamma(\delta(e))\, \ottkw{then}\,
            %     \gamma(\delta(e_1))\, \ottkw{else}\, \gamma(\delta(e_2))) \in \C{k}{\theta(t)}$.}

        }
            % \begin{proof}

            %     \step{}{By induction, we have $\den{}{}{\Theta; \Delta; \Gamma
            %         \vdash e : \: ! \ottkw{bool}}$, $\den{}{}{\Theta; \Delta;
            %         \Gamma' \vdash e_1: t'}$ and similarly for $e_2$.}

            %     \step{}{}

            % \end{proof}
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Pair\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, (a, b)\, =\, e\, \ottkw{in}\, e'))) \in \C{k}{\theta(t)}$.}
            {\pf\ Similar to \textsc{Ty\_Let} but with \textsc{Op\_Let\_Pair}}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bang\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{Many}\, e))) \in \C{k}{\theta(!t)}$.}
            \suffices{$(\sigma, \ottkw{Many}\, \gamma(\delta(e))) \in \C{k}{!\theta(t)}$.}
        }

        \begin{proof}

            \step{}{By assumption of \textsc{Ty\_Bang\_Intro}, $e = v$ for some
                value $v \neq l$, $\Gamma = \empH$ and so $\den{}{}{\Theta;
                \Delta; \cdot \vdash v : t}$ by induction.}

            \step{}{\suffices{$(\empH, \ottkw{Many}\, \delta(v)) \in
                \C{k}{!\theta(t)}$ by \ref{disjoint} and \ref{inL}.}}

            \step{}{Instantiate $\den{}{}{\Theta; \Delta; \cdot \vdash v : t}$
                with $\theta, k, \delta, \gamma = [], \sigma = \empH$ to obtain
                $(\empH, \delta(v)) \in \C{k}{\theta(t)}$.}

            \step{}{Instantiate $(\empH, \delta(v)) \in \C{k}{\theta(t)}$ with $j=0$, and
                $\sigma_r = \empH$, to conclude $(\empH, v) \in \V{k}{\theta(t)}$.}

            \step{}{??? By definition of $\V{k}{!\theta(t)}$, \ref{valueSub} and \ref{subsetVC} we
                have $(\empH, \ottkw{Many}\, \delta(v)) \in \C{k}{!\theta(t)}$.}

        \end{proof}
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bang\_Elim}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{let}\, \ottkw{Many}\, x\, =\, e\, \ottkw{in}\, e')))
                \in \C{k}{\theta(t)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Pair\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\, ( e, e')\, ))) \in \C{k}{\theta(t \otimes t')}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Lambda}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{fun}\, x : t' \rightarrow e))) \in \C{k}{\theta(t' \multimap t)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_App}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\,e \,e'\,))) \in \C{k}{\theta(t)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Gen}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\ottkw{fun}\, fc \rightarrow e))) \in \C{k}{\theta(\forall \, fc.\, t)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Spc}.
        }{%
            \prove{$(\sigma, \gamma(\delta(e\, [f]))) \in \C{k}{\theta(t\, [fc/f])}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Fix}.
        }{%
        \prove{$(\sigma, \gamma(\delta(\ottkw{fix} (g, x : t, e : t')))) \in \C{k}{\theta(!(t \multimap t'))}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Var\_Lin}.
        }{%
            \prove{$(\sigma, \gamma(\delta(x))) \in \C{k}{\theta(t)}$.}
            \begin{proof}
                \step{}{$\Gamma = \{ x : t\}$ by assumption of \textsc{Ty\_Var\_Lin}.}
                \step{}{\suffices{$(\sigma, \gamma(x)) \in \C{k}{\theta(t)}$ by \ref{disjoint}.}}
                \step{}{By \ref{inL}, there exist $(\sigma_x, v_x) \in \V{k}{\theta(t)}$, such
                    that $\sigma=\sigma_x$ and $\gamma = [x \mapsto v_x]$.}
                \step{}{??? Hence, $(\sigma_x, v_x) \in \C{k}{\theta(t)}$, by \ref{subsetVC}.}
            \end{proof}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Var}.
        }{%
            \prove{$(\sigma, \gamma(\delta(x))) \in \C{k}{\theta(t)}$.}
            \begin{proof}
                \step{}{$x : t \in \Delta$ and $\Gamma = \empH$ by assumption of \textsc{Ty\_Var}.}
                \step{}{\suffices{$(\empH, \delta(x)) \in \C{k}{\theta(t)}$ by \ref{disjoint} and \ref{inL}.}}
                \step{}{By \ref{inI}, there exists $v_x$ such that $(\empH, v_x) \in \V{k}{\theta(t)}$.}
                \step{}{??? Hence, $(\empH, v_x) \in \C{k}{\theta(t)}$, by \ref{subsetVC}.}
            \end{proof}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Unit\_Intro}.
        }{%
            \prove{$(\sigma, \gamma(\delta(\, ()\,))) \in \C{k}{\theta(\Unit)}$.\\}
        }
    }

    \step{}{%
        \case{%
            \textsc{Ty\_Bool\_True}, \textsc{Ty\_Bool\_False}, \textsc{Ty\_Int\_Intro}, \textsc{Ty\_Elt\_Intro}.
        }{%
            Similar to \textsc{Ty\_Unit\_Intro}.
        }
    }

\end{proof}
